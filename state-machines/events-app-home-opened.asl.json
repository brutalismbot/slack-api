{
  "StartAt": "Get Request",
  "States": {
    "Get Request": {
      "Type": "Parallel",
      "Next": "Send Request",
      "ResultSelector": {
        "path": "api/views.publish",
        "headers.$": "$[0]",
        "body": {
          "user_id.$": "$[1].user_id",
          "view.$": "States.JsonToString($[1].view)"
        }
      },
      "Branches": [
        {
          "StartAt": "Get Headers",
          "States": {
            "Get Headers": {
              "Type": "Task",
              "Resource": "arn:aws:states:::dynamodb:getItem",
              "End": true,
              "ResultSelector": {
                "content-type": "application/json; charset=utf-8",
                "authorization.$": "States.Format('Bearer {}', $.Item.ACCESS_TOKEN.S)"
              },
              "Parameters": {
                "TableName": "${table_name}",
                "ProjectionExpression": "ACCESS_TOKEN",
                "Key": {
                  "GUID": { "S.$": "States.Format('{}/{}', $.api_app_id, $.team_id)" },
                  "SORT": { "S": "SLACK/AUTH" }
                }
              }
            }
          }
        },
        {
          "StartAt": "Get Body",
          "States": {
            "Get Body": {
              "Type": "Pass",
              "End": true,
              "Parameters": {
                "user_id.$": "$.event.user",
                "view": {
                  "type": "home",
                  "callback_id": "settings",
                  "title": {
                    "type": "plain_text",
                    "text": "Brutalismbot Home",
                    "emoji": true
                  },
                  "blocks": [
                    {
                      "type": "image",
                      "image_url": "https://brutalismbot.com/banner.png",
                      "alt_text": "brutalist"
                    },
                    {
                      "type": "header",
                      "text": {
                        "type": "plain_text",
                        "text": "Settings",
                        "emoji": true
                      }
                    },
                    {
                      "block_id": "conversation_select",
                      "type": "section",
                      "text": {
                        "type": "mrkdwn",
                        "text": "Brutalismbot will post messages toâ€¦"
                      },
                      "accessory": {
                        "type": "conversations_select",
                        "action_id": "conversation_select",
                        "placeholder": {
                          "type": "plain_text",
                          "text": "Select channel",
                          "emoji": true
                        }
                      }
                    },
                    {
                      "block_id": "save",
                      "type": "actions",
                      "elements": [
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "Save",
                            "emoji": true
                          },
                          "value.$": "States.Format('{}', $.event_time)",
                          "action_id": "save"
                        }
                      ]
                    }
                  ]
                }
              }
            }
          }
        }
      ]
    },
    "Send Request": {
      "Type": "Task",
      "Resource": "arn:aws:states:::events:putEvents",
      "End": true,
      "Parameters": {
        "Entries": [{
          "Detail": {
            "headers.$": "$.headers",
            "body.$": "States.JsonToString($.body)"
          },
          "DetailType.$": "$.path",
          "EventBusName": "brutalismbot",
          "Source": "slack"
        }]
      }
    }
  }
}
